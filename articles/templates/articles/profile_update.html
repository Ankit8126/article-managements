{% extends "DashBoard/nav.html" %}
{% load static %}
{% block title %}Update User Profile{% endblock %}
{% block style %}
<link href="{% static 'css/users.css' %}" rel="stylesheet">
<style>
  .user-profile {
    margin-top: 30px;
  }
  .profile-header {
    background-color: #ffffff;
    padding: 30px;
    text-align: center;
    border-radius: 12px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  .profile-header img {
    max-width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 20px;
    border: 4px solid #007bff;
  }
  .profile-header h3 {
    margin: 10px 0;
    font-weight: bold;
    color: #333;
  }
  .profile-header p {
    font-size: 16px;
    color: #6c757d;
    margin: 5px 0;
  }

  .profile-details {
    background-color: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
  }

  .profile-details .row {
    margin-bottom: 15px;
  }

  .profile-details label {
    font-weight: bold;
    color: #007bff;
  }

  .profile-details .value {
    color: #495057;
    font-size: 16px;
  }

  .profile-details .row .col-md-3 {
    font-size: 14px;
    color: #495057;
  }

  .profile-details .row .col-md-9 {
    font-size: 16px;
    color: #6c757d;
    font-style: italic;
  }

  .active-status {
    color: #28a745;
    font-weight: bold;
  }

  .inactive-status {
    color: #dc3545;
    font-weight: bold;
  }

  .form-control {
    border-radius: 8px;
    padding: 10px;
  }
  .form-group {
    margin-bottom: 20px;
  }

  .update-btn {
    background-color: #007bff;
    color: #fff;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    font-size: 16px;
  }

  .update-btn:hover {
    background-color: #0056b3;
  }
  /* Profile Picture Container */
  .profile-picture-container {
  position: relative;
  width: 150px;  
  height: 150px;
}

.profile-picture-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;  /* Ensures the image is cropped to fit the container */
  border-radius: 50%;
}

.add-image-icon {
  position: absolute;
  top: 50%;  /* Position it in the vertical center */
  left: 50%; /* Position it in the horizontal center */
  transform: translate(-50%, -50%);  /* Offset the icon by 50% of its own width/height */
  background-color: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  padding: 10px;
  color: #fff;
  cursor: pointer;
  font-size: 18px;
  width: 50px;
  height: 50px;
}

.add-image-icon:hover {
  background-color: rgba(0, 0, 0, 0.7);  /* Darker background on hover */
}


/* Form styles */
.profile-details {
  background-color: #f9f9f9;
  padding: 20px;
  border-radius: 8px;
}

.profile-details .row {
  margin-bottom: 15px;
}

.profile-details label {
  font-weight: bold;
  color: #555;
}

.profile-details input,
.profile-details textarea,
.profile-details select {
  border-radius: 4px;
}

.update-btn {
  background-color: #007bff;
  color: #fff;
  border: none;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 5px;
  width: 100%;
}

.update-btn:hover {
  background-color: #0056b3;
  cursor: pointer;
}

</style>
{% endblock %}

{% block content %}
<div class="main-container w-100">
    <div class="container user-profile">
      <div class="row mb-4">
        <!-- Back Button (Top Left) -->
        <div class="col-6">
          <button class="btn btn-secondary" id="back-button">
            <i class="fas fa-arrow-left"></i> Back
          </button>
        </div>
      </div>
  
      <div class="profile-header text-center">
        <!-- Profile Picture with Image Edit Icon -->
        <div class="profile-picture-container position-relative">
  <img id="profile-picture" src="{% static 'images/default-profile.png' %}" alt="Profile Picture" class="img-fluid rounded-circle">
  <div class="add-image-icon position-absolute " id="profile-picture">
    <i class="fas fa-camera"></i>
  </div>
</div>
        <h3 id="user_username">Loading...</h3>
        <p id="userroleandname">Loading...</p>
        <p id="date-joined">Joined: Loading...</p>
      </div>
  
      <form id="update-profile-form" class="profile-details">
        <div class="row">
          <div class="col-md-3">
            <label for="bio">Bio:</label>
          </div>
          <div class="col-md-9">
            <textarea class="form-control" id="bio" name="bio" rows="4" placeholder="Enter Bio"></textarea>
          </div>
        </div>
  
        <div class="row">
          <div class="col-md-3">
            <label for="contact_info">Contact Info:</label>
          </div>
          <div class="col-md-9">
            <textarea class="form-control" id="contact_info" name="contact_info" rows="4" placeholder="Enter Contact Info"></textarea>
          </div>
        </div>
  
        <div class="row">
          <div class="col-md-3">
            <label for="fname">First Name:</label>
          </div>
          <div class="col-md-9">
            <input type="text" class="form-control" id="fname" name="fname" placeholder="Enter First Name">
          </div>
        </div>
  
        <div class="row">
          <div class="col-md-3">
            <label for="lname">Last Name:</label>
          </div>
          <div class="col-md-9">
            <input type="text" class="form-control" id="lname" name="lname" placeholder="Enter Last Name">
          </div>
        </div>
  
        <div class="row">
          <div class="col-md-3">
            <label for="email">Email:</label>
          </div>
          <div class="col-md-9">
            <input type="email" class="form-control" id="email" name="email" placeholder="Enter Email">
          </div>
        </div>
  
        <!-- Profile Picture Selection -->
        <input type="file" class="d-none" id="profile_picture" name="profile_picture" accept="image/*">
  
        <button type="submit" class="btn btn-primary update-btn">Update Profile</button>
      </form>
    </div>
  </div>

  
<!-- Modal for Successful Profile Updation -->
<div class="modal fade" id="submissionSuccessModal" tabindex="-1" aria-labelledby="submissionSuccessModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="submissionSuccessModalLabel">Profile Updated Successfully</h5>
        </div>
        <div class="modal-body">
          <p>Your Profile has been successfully Updated!</p>
        </div>
        <div class="modal-footer">
          <!-- Button to see the article -->
          <a id="seeArticleBtn" href="/articles/profile/" class="btn btn-success">See Profile</a>
          <!-- Button to go back to the dashboard -->
          <a id="backToDashboardBtn" href="/articles/dashboard/" class="btn btn-secondary">Back to Dashboard</a>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block script %}
<script>
    userId={{id}}
  document.addEventListener("DOMContentLoaded", function() {
    // Get the user ID from the URL
    
    // Fetch user data to populate fields
    const apiUrl = `http://127.0.0.1:8000/api/detail/${userId}/`;
    const token = localStorage.getItem('token');  // Assuming the token is stored in localStorage

    fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      // Populate the form fields with user data
      if (data) {
        document.getElementById('profile-picture').src = data.profile.profile_picture ? data.profile.profile_picture : '{% static "images/default-profile.png" %}';
        document.getElementById('user_username').textContent = data.username;
        document.getElementById('userroleandname').textContent =`${data.first_name } ${data.last_name} \(${data.role}\)`;
        document.getElementById('date-joined').textContent = `Joined: ${new Date(data.date_joined).toLocaleDateString()}`;
        document.getElementById('bio').value = data.profile.bio || '';
        document.getElementById('contact_info').value = data.profile.contact_info || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('fname').value=data.first_name;
        document.getElementById('lname').value=data.last_name;
      }
    })
    .catch(error => {
      console.error('Error fetching user data:', error);
      alert('Failed to load user details.');
    });

    // Handle the form submission
    document.getElementById('update-profile-form').addEventListener('submit', function(event) {
        event.preventDefault();
      
        const updatedData = {
          first_name: document.getElementById('fname').value,
          last_name: document.getElementById('lname').value,
          email: document.getElementById('email').value,
          profile: {
            bio: document.getElementById('bio').value,
            contact_info: document.getElementById('contact_info').value,
            profile_picture: document.getElementById('profile_picture').files[0]  // Assuming file input
          }
        };
      
        const formData = new FormData();
        
        // Append all profile fields
        for (const key in updatedData.profile) {
          if (updatedData.profile[key]) {
            formData.append(`profile.${key}`, updatedData.profile[key]);
          }
        }
      
        // Append other fields (user details)
        formData.append('first_name', updatedData.first_name);
        formData.append('last_name', updatedData.last_name);
        formData.append('email', updatedData.email);
        
        // Send PUT request
        fetch(`http://127.0.0.1:8000/api/update/${userId}/`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
          },
          body: formData,
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'Success') {
            const modal = new bootstrap.Modal(document.getElementById('submissionSuccessModal'));
            modal.show();
          } else {
            alert('Error updating profile. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error updating profile:', error);
          alert('An error occurred. Please try again later.');
        });
      });
  });

  document.getElementById('profile-picture').addEventListener('click', function() {
    document.getElementById('profile_picture').click();
  });
  
  // When the user selects a new image, update the profile picture
  document.getElementById('profile_picture').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('profile-picture').src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
</script>
{% endblock %}
